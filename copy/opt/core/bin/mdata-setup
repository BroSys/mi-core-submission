#!/bin/bash

# SPIPEs
/opt/core/bin/spiped-configure-smf api-redis encrypt [127.0.0.1]:63790 [$(mdata-get api_redis_addr)]:63790 $(mdata-get api_redis_key)
/opt/core/bin/spiped-configure-smf mbox-lmtp encrypt [127.0.0.1]:24 [$(mdata-get mbox_lmtp_addr)]:2424 $(mdata-get mbox_lmtp_key)

# for SSL
mdata-get mx_ssl > /opt/local/etc/exim/ssl/exim.pem
chmod 400 /opt/local/etc/exim/ssl/exim.pem

##
## Exim special configuration
##
EXIMLOCAL=/opt/local/etc/exim/configure.local
echo "## File generated by mdata-setup script" > $EXIMLOCAL

# Default Domainkey
mdata-get domainkey > /opt/local/etc/exim/domain.key
echo "DEFAULT_DOMAINKEY = /opt/local/etc/exim/domain.key" >> $EXIMLOCAL

# Secrets for SRS-Hash
# Define old an new to be able to change secrets
echo "SRS_SECRET = $(mdata-get srs_secret)" >> $EXIMLOCAL
echo "SRS_OLD_SECRET = $(mdata-get srs_secret_old)" >> $EXIMLOCAL
##
## END Exim special configuration
##

# munin
MUNIN_CONF='/opt/local/etc/munin/munin-node.conf'

cp ${MUNIN_CONF}.tpl ${MUNIN_CONF}
if mdata-get munin_allow 1>/dev/null 2>&1; then
	echo "# mdata-get munin_allow" >> ${MUNIN_CONF}
	for allow in $(mdata-get munin_allow); do
		echo "cidr_allow ${allow}" >> ${MUNIN_CONF}
	done
fi

if mdata-get munin_deny 1>/dev/null 2>&1; then
	echo "# mdata-get munin_deny" >> ${MUNIN_CONF}
	for deny in $(mdata-get munin_deny); do
		echo "cidr_deny ${deny}" >> ${MUNIN_CONF}
	done
fi
